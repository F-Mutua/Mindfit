{% extends "base.html" %}

{% block title %}My Study Sessions - MindFit Learn{% endblock %}

{% block extra_css %}
<style>
    .session-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid #0d6efd;
    }
    .session-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
    }
    .mood-indicator {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        vertical-align: middle;
    }
    .mood-very-stressed { background-color: #dc3545; }
    .mood-stressed { background-color: #fd7e14; }
    .mood-neutral { background-color: #ffc107; }
    .mood-relaxed { background-color: #198754; }
    .mood-very-relaxed { background-color: #0d6efd; }
    .tag {
        display: inline-block;
        background-color: #e9ecef;
        border-radius: 20px;
        padding: 2px 10px;
        margin: 2px;
        font-size: 0.8rem;
        color: #495057;
    }
    .duration-badge {
        font-size: 0.9rem;
        font-weight: 500;
    }
    .subject-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #6c757d;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }
    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">My Study Sessions</h1>
            <p class="text-muted mb-0">Track and analyze your study history and progress</p>
        </div>
        <div>
            <a href="{{ url_for('new_study_session') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>New Session
            </a>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-0">
            <div class="filter-section">
                <form method="GET" class="row g-3">
                    <div class="col-md-4">
                        <label for="subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="subject" name="subject" 
                               placeholder="Filter by subject" value="{{ request.args.get('subject', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label for="date_from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ request.args.get('date_from', '') }}">
                    </div>
                    <div class="col-md-3">
                        <label for="date_to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" 
                               value="{{ request.args.get('date_to', '') }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-2"></i>Filter
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Sessions</h6>
                            <h3 class="mb-0">{{ stats.total_sessions }}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-book text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Study Time</h6>
                            <h3 class="mb-0">{{ "%02d"|format(stats.total_hours) }}:{{ "%02d"|format(stats.total_minutes) }}</h3>
                        </div>
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-clock text-success" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Average Mood</h6>
                            <h3 class="mb-0">
                                <span class="mood-indicator mood-{{ stats.average_mood|lower|replace(' ', '-') }}"></span>
                                {{ stats.average_mood }}
                            </h3>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="fas fa-smile text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sessions List -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Study Sessions</h5>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                            id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-sort me-1"></i>
                        {% if request.args.get('sort') == 'date_asc' %}
                            Date (Oldest First)
                        {% elif request.args.get('sort') == 'duration_desc' %}
                            Duration (Longest First)
                        {% elif request.args.get('sort') == 'duration_asc' %}
                            Duration (Shortest First)
                        {% else %}
                            Date (Newest First)
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
                        <li><a class="dropdown-item {% if not request.args.get('sort') or request.args.get('sort') == 'date_desc' %}active{% endif %}" 
                              href="{{ url_for('study_sessions', **{**request.args, 'sort': 'date_desc'}) }}">
                            Date (Newest First)
                        </a></li>
                        <li><a class="dropdown-item {% if request.args.get('sort') == 'date_asc' %}active{% endif %}" 
                              href="{{ url_for('study_sessions', **{**request.args, 'sort': 'date_asc'}) }}">
                            Date (Oldest First)
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item {% if request.args.get('sort') == 'duration_desc' %}active{% endif %}" 
                              href="{{ url_for('study_sessions', **{**request.args, 'sort': 'duration_desc'}) }}">
                            Duration (Longest First)
                        </a></li>
                        <li><a class="dropdown-item {% if request.args.get('sort') == 'duration_asc' %}active{% endif %}" 
                              href="{{ url_for('study_sessions', **{**request.args, 'sort': 'duration_asc'}) }}">
                            Duration (Shortest First)
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if sessions.items %}
                <div class="list-group list-group-flush">
                    {% for session in sessions.items %}
                        <a href="{{ url_for('view_session', session_id=session.id) }}" 
                           class="list-group-item list-group-item-action py-3 session-card">
                            <div class="d-flex align-items-center">
                                <div class="subject-icon me-3">
                                    <i class="fas fa-{{ session.subject_icon or 'book' }}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-1">{{ session.subject }}</h6>
                                        <span class="badge bg-{{ 'success' if session.completed else 'warning' }} ms-2">
                                            {{ 'Completed' if session.completed else 'In Progress' }}
                                        </span>
                                    </div>
                                    <div class="d-flex flex-wrap align-items-center text-muted small mb-1">
                                        <span class="me-3">
                                            <i class="far fa-calendar me-1"></i>
                                            {{ session.date.strftime('%b %d, %Y') }}
                                        </span>
                                        <span class="me-3">
                                            <i class="far fa-clock me-1"></i>
                                            {{ session.start_time.strftime('%I:%M %p') }}
                                        </span>
                                        <span class="me-3">
                                            <i class="fas fa-hourglass-half me-1"></i>
                                            {{ session.duration }} mins
                                        </span>
                                        <span>
                                            <span class="mood-indicator mood-{{ session.mood|lower|replace(' ', '-') }}"></span>
                                            {{ session.mood }}
                                        </span>
                                    </div>
                                    {% if session.notes %}
                                        <p class="text-muted small mb-0">
                                            {{ session.notes|truncate(120) }}
                                        </p>
                                    {% endif %}
                                    {% if session.tags %}
                                        <div class="mt-2">
                                            {% for tag in session.tags %}
                                                <span class="tag">{{ tag }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="ms-3 text-end">
                                    <span class="badge bg-primary duration-badge">
                                        {{ "%02d"|format(session.duration // 60) }}:{{ "%02d"|format(session.duration % 60) }}
                                    </span>
                                </div>
                            </div>
                        </a>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if sessions.pages > 1 %}
                    <nav class="d-flex justify-content-center mt-4 mb-3">
                        <ul class="pagination">
                            <li class="page-item {% if not sessions.has_prev %}disabled{% endif %}">
                                <a class="page-link" 
                                   href="{{ url_for('study_sessions', page=sessions.prev_num, **request.args) if sessions.has_prev else '#' }}">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            
                            {% for page_num in sessions.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    <li class="page-item {% if page_num == sessions.page %}active{% endif %}">
                                        <a class="page-link" 
                                           href="{{ url_for('study_sessions', page=page_num, **request.args) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            <li class="page-item {% if not sessions.has_next %}disabled{% endif %}">
                                <a class="page-link" 
                                   href="{{ url_for('study_sessions', page=sessions.next_num, **request.args) if sessions.has_next else '#' }}">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-book text-muted" style="font-size: 3rem; opacity: 0.5;"></i>
                    </div>
                    <h5 class="text-muted">No Study Sessions Found</h5>
                    <p class="text-muted">
                        {% if request.args.get('subject') or request.args.get('date_from') or request.args.get('date_to') %}
                            Try adjusting your filters or <a href="{{ url_for('study_sessions') }}">clear all filters</a>.
                        {% else %}
                            Start your first study session to track your progress.
                        {% endif %}
                    </p>
                    <a href="{{ url_for('new_study_session') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Start a Session
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Export and Other Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="#" class="btn btn-outline-secondary">
                <i class="fas fa-download me-2"></i>Export Data
            </a>
        </div>
        <div>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date pickers with default ranges
    const today = new Date();
    const dateFrom = document.getElementById('date_from');
    const dateTo = document.getElementById('date_to');
    
    // Set default date range (last 30 days) if not set
    if (!dateFrom.value && !dateTo.value) {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        dateFrom.valueAsDate = thirtyDaysAgo;
        dateTo.valueAsDate = today;
    }
    
    // Ensure date range is valid
    dateFrom.max = today.toISOString().split('T')[0];
    dateTo.max = today.toISOString().split('T')[0];
    
    dateFrom.addEventListener('change', function() {
        dateTo.min = this.value;
    });
    
    dateTo.addEventListener('change', function() {
        dateFrom.max = this.value;
    });
});
</script>
{% endblock %}
